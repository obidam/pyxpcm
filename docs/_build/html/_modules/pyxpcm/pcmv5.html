

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyxpcm.pcmv5 &mdash; pyxpcm 0.1.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="pyxpcm 0.1.3 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pyxpcm
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview: What is a PCM?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../methodology.html">Statistics of Profile Classification Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCMclass.html">The PCM class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stats.html">Computing PCM-based statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting PCM results</a></li>
</ul>
<p class="caption"><span class="caption-text">Help &amp; reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">What&#8217;s New</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyxpcm</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyxpcm.pcmv5</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyxpcm.pcmv5</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">.. module:: pcm</span>
<span class="sd">   :synopsis: Profile Classification Model</span>

<span class="sd">.. moduleauthor:: Guillaume Maze &lt;gmaze@ifremer.fr&gt;</span>

<span class="sd">Consume xarray.datasets only</span>
<span class="sd">Variables in the dataset used for the classification are assumed to already be in 2d: [n_samples, n_features]</span>

<span class="sd">USE CASE:</span>

<span class="sd">K sets the nb of classes</span>
<span class="sd">Z sets the vertical axis of the model:</span>
<span class="sd">    K = 8</span>
<span class="sd">    Z = np.arange(0,1000,5)</span>
<span class="sd">Then we create the PCM instance:</span>
<span class="sd">    m = pcm(K=K, feature_axis=Z, feature_name=&#39;temperature&#39;)</span>
<span class="sd">feature_axis defines the model vertical axis on which data must be defined or interpolated</span>
<span class="sd">feature_name defines the variable name to be used from the xr.dataset for classification</span>

<span class="sd">Now, open a dataset already in 2d: [n_samples, n_features]:</span>
<span class="sd">    ds = xr.open_dataset(&#39;PROFILES.nc&#39;)</span>

<span class="sd">And fit a PCM:</span>
<span class="sd">    m = m.fit(ds)</span>
<span class="sd">We don&#39;t need to provide the name of the feature axis in ds (that would be &#39;DEPTH&#39;) to be compared against the PCM</span>
<span class="sd">own axis &#39;feature axis&#39; because in this version, we assume all features to be already in</span>
<span class="sd">2d-like: [n_samples, n_features]. So we know by default that we need to compare the 2nd dimension axis of the feature</span>
<span class="sd">to the PCM own feature_axis array.</span>
<span class="sd">    ds[&#39;temperature&#39;].dims[1] to be compared with m.feature_axis</span>


<span class="sd">Note that if the m.feature_name string property (eg: &#39;temperature&#39;) is not a variable in</span>
<span class="sd">the dataset, we may want to look for an attributes &#39;feature_name&#39; to identify it.</span>
<span class="sd">    ds[&#39;TEMP&#39;].attrs[&#39;feature_name&#39;] = &#39;temperature&#39;</span>
<span class="sd">This allows to classify a dataset without changing variables name by simply adding an attribute to one of them</span>

<span class="sd">We can also provide a dictionary to the fit/predict methods</span>
<span class="sd">    m = m.fit(ds, features={&#39;temperature&#39;:&#39;TEMP&#39;})</span>

<span class="sd">If we anticipate on the multi-variables classification,</span>
<span class="sd">we will need to define model feature axis for each of the feature variables to be used,</span>
<span class="sd">so, we can think of a dictionary like:</span>
<span class="sd">    m = pcm(K=K, features={&#39;temperature&#39;:Z, &#39;salinity&#39;:Z, &#39;sea_level&#39;:None})</span>

<span class="sd">If, again, we assume the dataset is already prepared with 2-d like [n_samples, n_features] variables, we simply need to</span>
<span class="sd">map dataset variable names to the PCM feature names</span>
<span class="sd">    m = m.fit(ds, feature={&#39;temperature&#39;: &#39;TEMP&#39;, &#39;salinity&#39;: &#39;PSAL&#39;, &#39;sea_level&#39;: &#39;SLA&#39;})</span>


<span class="sd">Created on 2017/09/26</span>
<span class="sd">@author: gmaze</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">.plot</span> <span class="k">import</span> <span class="n">_PlotMethods</span>

<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="k">import</span> <span class="n">validation</span>

<span class="c1"># http://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">preprocessing</span>

<span class="c1"># http://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>

<span class="c1"># http://scikit-learn.org/stable/modules/mixture.html</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="k">import</span> <span class="n">GaussianMixture</span>

<span class="k">class</span> <span class="nc">PCM</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Common base class for a Profile Classification Model</span>
<span class="sd">        Consume and return xarrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">feature_axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">feature_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">scaling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">reduction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxvar</span><span class="o">=</span><span class="mf">99.9</span><span class="p">,</span>
                 <span class="n">classif</span><span class="o">=</span><span class="s1">&#39;gmm&#39;</span><span class="p">,</span> <span class="n">COVARTYPE</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span>
                 <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the PCM instance&quot;&quot;&quot;</span>
        <span class="k">if</span>   <span class="n">scaling</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">with_scaler</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span> <span class="n">with_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">;</span> <span class="n">with_std</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">scaling</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">with_scaler</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">;</span> <span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">with_std</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">scaling</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">with_scaler</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">;</span> <span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">;</span> <span class="n">with_std</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;scaling must be 0, 1 or 2&#39;</span><span class="p">)</span>
        
        <span class="k">if</span>   <span class="n">reduction</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">with_reducer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">reduction</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">with_reducer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;reduction must be 0 or 1&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">classif</span><span class="o">==</span><span class="s1">&#39;gmm&#39;</span><span class="p">:</span> <span class="n">with_classifier</span> <span class="o">=</span> <span class="s1">&#39;gmm&#39;</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;classifier must be &#39;gmm&#39; (no other methods implemented at this time)&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">K</span><span class="p">),</span>
                        <span class="s1">&#39;llh&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;COVARTYPE&#39;</span><span class="p">:</span> <span class="n">COVARTYPE</span><span class="p">,</span>
                        <span class="s1">&#39;with_scaler&#39;</span><span class="p">:</span> <span class="n">with_scaler</span><span class="p">,</span>
                        <span class="s1">&#39;with_reducer&#39;</span><span class="p">:</span> <span class="n">with_reducer</span><span class="p">,</span>
                        <span class="s1">&#39;with_classifier&#39;</span><span class="p">:</span> <span class="n">with_classifier</span><span class="p">,</span>
                        <span class="s1">&#39;maxvar&#39;</span><span class="p">:</span> <span class="n">maxvar</span><span class="p">,</span>
                        <span class="s1">&#39;inplace&#39;</span><span class="p">:</span> <span class="n">inplace</span><span class="p">,</span>
                        <span class="s1">&#39;feature_axis&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">feature_axis</span><span class="p">),</span>
                        <span class="s1">&#39;feature_name&#39;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trained</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#todo _trained is a property, should be set/get with a decorator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">verb</span> <span class="c1">#todo _verb is a property, should be set/get with a decorator</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_interpoler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Interp</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_axis&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">(</span><span class="n">with_mean</span><span class="o">=</span><span class="n">with_mean</span><span class="p">,</span>
                                                    <span class="n">with_std</span><span class="o">=</span><span class="n">with_std</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler_props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;?&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reducer</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;maxvar&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                           <span class="n">svd_solver</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">],</span>
                                          <span class="n">covariance_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;COVARTYPE&#39;</span><span class="p">],</span>
                                          <span class="n">init_params</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span>
                                          <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                          <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="s1">&#39;0.5&#39;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">__Interp</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Internal machinery for the interpolation of vertical profiles</span>
<span class="sd">            </span>
<span class="sd">            This class is called once at PCM instance initialisation and</span>
<span class="sd">            whenever data to be classified are not on the PCM feature axis.</span>

<span class="sd">            Here we consume numpy arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doINTERPz</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">def</span> <span class="nf">isnecessary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Caxis</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Check wether or not the input data vertical axis is different</span>
<span class="sd">                from the PCM one, if not, avoid interpolation</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1">#todo We should be smarter and recognize occurences of z in DPTmodel</span>
            <span class="c1"># or viceversa in order to limit interpolation as much as possible !</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">Caxis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doINTERPz</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equiv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">Caxis</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">doINTERPz</span>
        
        <span class="k">def</span> <span class="nf">mix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">                Homogeneize the upper water column: </span>
<span class="sd">                Set 1st nan value to the first non-NaN value</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1">#izmixed = np.argwhere(np.isnan(x))</span>
            <span class="n">izok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#x[izmixed] = x[izok]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">izok</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
        
        <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Caxis</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Interpolate data on the PCM vertical axis</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isnecessary</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">Caxis</span><span class="p">)):</span>
                <span class="p">[</span><span class="n">Np</span><span class="p">,</span> <span class="n">Nz</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span>            
                <span class="c1"># Possibly Create a mixed layer for the interpolation to work </span>
                <span class="c1"># smoothly at the surface</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">Caxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)):</span>
                    <span class="n">Caxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">Caxis</span><span class="p">))</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Np</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">C</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mix</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
                <span class="c1"># Linear interpolation of profiles onto the model grid:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">Caxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Np</span><span class="p">),</span> <span class="n">C</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Np</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">C</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">K</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of classes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feature_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the feature axis array&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_axis&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the scaler method&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display detailled parameters of the PCM</span>
<span class="sd">            This is not a get_params because it doesn&#39;t return a dictionnary</span>
<span class="sd">            Set Boolean option &#39;deep&#39; to True for all properties display</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;&lt;pcm &#39;</span><span class="si">%s</span><span class="s2">&#39; (K: </span><span class="si">%i</span><span class="s2">, Z: </span><span class="si">%i</span><span class="s2">)&gt;&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;with_classifier&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_axis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        
        <span class="c1"># PCM core properties:</span>
        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Number of class: </span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>

        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Feature name: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">]))</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>

        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Feature axis: [</span><span class="si">%s</span><span class="s1">, ..., </span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_axis&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_axis&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>
        
        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Trained: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trained</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>
        
        <span class="c1"># PCM workflow parameters:</span>
        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Feature axis Interpolation: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpoler</span><span class="o">.</span><span class="n">doINTERPz</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>    
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Interpoler: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interpoler</span><span class="p">)))</span>
        
        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Sample Scaling: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;with_scaler&#39;</span><span class="p">]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Scaler: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">deep</span><span class="p">):</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Scaler properties:&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>
        
        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dimensionality Reduction: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;with_reducer&#39;</span><span class="p">]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>       
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Reducer: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reducer</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">deep</span><span class="p">):</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Reducer properties:&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reducer</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>
        
        <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Classification: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;with_classifier&#39;</span><span class="p">]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span> 
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Classifier: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="p">)))</span>
        <span class="c1">#prop_info = (&#39;GMM covariance type: %s&#39;) % self._props[&#39;COVARTYPE&#39;]</span>
        <span class="c1">#summary.append(prop_info)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trained</span><span class="p">):</span>
            <span class="n">prop_info</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> log likelihood: </span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_info</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">deep</span><span class="p">):</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Classifier properties:&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>
        
        <span class="c1"># Done</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verb</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a deep copy of the PCM instance&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__id_feature_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify the dataset variable name to be used as a feature&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">real_feature_name</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">]]</span>
            <span class="n">feature_name_found</span> <span class="o">=</span> <span class="n">real_feature_name</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">]</span>
            <span class="n">feature_name_found</span> <span class="o">=</span> <span class="n">real_feature_name</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_name_found</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;feature_name&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">real_feature_name</span><span class="p">):</span>
                        <span class="n">real_feature_name</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="n">feature_name_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_name_found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="p">(</span><span class="s2">&quot;Feature &#39;</span><span class="si">%s</span><span class="s2">&#39; not found in this dataset. You may want to add the &#39;feature_name&#39; &quot;</span>
                              <span class="s2">&quot;attribute to the variable you&#39;d like to use or provide a dictionnary&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">real_feature_name</span>

    <span class="k">def</span> <span class="nf">preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Pre-process data for classification</span>

<span class="sd">            Possible pre-processing steps:</span>
<span class="sd">                interpolation,</span>
<span class="sd">                scaling,</span>
<span class="sd">                reduction</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ds: xarray.Dataset</span>
<span class="sd">            feature (optional): the xarray.Dataset variable name to be used as the PCM feature. If not specified, the</span>
<span class="sd">                variable is identified as PCM[&#39;feature_name&#39;] or the variable having it as an attribute.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            X, the pre-processed feature variable</span>
<span class="sd">            </span>
<span class="sd">            Example</span>
<span class="sd">            -------</span>
<span class="sd">            m = pcm(K=8, feature_axis=range(0,-1000,-10), feature_name=&#39;temperature&#39;)</span>
<span class="sd">            X = m.preprocessing(ds)</span>
<span class="sd">            X = m.preprocessing(ds, feature={&#39;temperature&#39;:&#39;TEMP&#39;})</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Identify the feature in this dataset:</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_feature_name</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
        <span class="n">sampling_axis_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">feature_axis_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Ensure that the feature name is of shape [n_samples, n_features]:</span>
        <span class="c1">#   - the 2nd dimension of the feature_name variable must be the</span>
        <span class="c1">#       specified feature_axis</span>
        <span class="c1"># if (feature_axis != None):</span>
        <span class="c1">#     if not ds[feature_name].dims[1] == feature_axis:</span>
        <span class="c1">#         raise ValueError</span>
        <span class="c1"># else:</span>
        <span class="c1">#     feature_axis = str(ds[feature_name].dims[1])</span>

        <span class="c1"># INTERPOLATION:</span>
        <span class="c1"># (in this version, the interpoler class keeps consuming numpy arrays)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpoler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                           <span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">][</span><span class="n">feature_axis_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># SCALING:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler_props</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># REDUCTION:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;with_reducer&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reducer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reducer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Output:</span>
        <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate PCM parameters</span>

<span class="sd">        For a PCM, the fit method consists in the following operations:</span>

<span class="sd">        - pre-processing</span>
<span class="sd">            - interpolation to the feature_axis levels of the model</span>
<span class="sd">            - scaling</span>
<span class="sd">            - reduction</span>
<span class="sd">        - estimate classifier parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds: xarray.Dataset</span>
<span class="sd">        feature (optional): the xarray.Dataset variable name to be used as the PCM feature. If not specified, the</span>
<span class="sd">            variable is identified as PCM[&#39;feature_name&#39;] or the variable having it as an attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Identify the feature name in the dataset:</span>
        <span class="c1"># feature_name = self.__id_feature_name(ds)</span>

        <span class="c1"># PRE-PROCESSING:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>

        <span class="c1"># CLASSIFICATION-MODEL TRAINING:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Done:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trained</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelname</span><span class="o">=</span><span class="s1">&#39;PCM_LABELS&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict labels for profile samples</span>

<span class="sd">           This method add these properties to the PCM object:</span>
<span class="sd">              llh: The log likelihood of the model with regard to new data</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ds: xarray.Dataset</span>
<span class="sd">            feature: str, optional</span>
<span class="sd">                The xarray.Dataset variable name to be used as the PCM feature. If not specified, the</span>
<span class="sd">                variable is identified as PCM[&#39;feature_name&#39;] or the variable having it as an attribute.</span>
<span class="sd">            inplace: boolean, False by default</span>
<span class="sd">                If False, the method returns a xarray.DataArray with predicted labels</span>
<span class="sd">                If True, a xarray.DataArray with labels is added to the input xarray.Dataset</span>
<span class="sd">            labelname: str, default is &#39;PCM_LABELS&#39;</span>
<span class="sd">                Name of the DataArray with labels</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            xarray.DataArray</span>
<span class="sd">                Component labels (if option &#39;inplace&#39; = False)</span>
<span class="sd">            or</span>
<span class="sd">            xarray.Dataset</span>
<span class="sd">                Input dataset with Component labels as a &#39;PCM_LABELS&#39; new xarray.DataArray</span>
<span class="sd">                (if option &#39;inplace&#39; = True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the PCM is trained:</span>
        <span class="n">validation</span><span class="o">.</span><span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_trained&#39;</span><span class="p">,</span>
                                   <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;This </span><span class="si">%(name)s</span><span class="s2"> instance is not fitted yet. Call fit with appropriate &quot;</span>
                                       <span class="s2">&quot;arguments before using the predict method.&quot;</span><span class="p">)</span>

        <span class="c1"># PRE-PROCESSING:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>

        <span class="c1"># CLASSIFICATION PREDICTION:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Prepare xarray for output:</span>

        <span class="c1"># Identify the feature name in the dataset:</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_feature_name</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">sampling_axis_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># feature_axis_name = str(ds[feature_name].dims[1])</span>

        <span class="c1"># Identify the sampling dimension name:</span>
        <span class="c1"># dim_sample_name = list(set(ds[feature_name].dims).symmetric_difference([feature_axis]))[0]</span>

        <span class="c1"># Create a xarray.DataArray with labels:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">sampling_axis_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">labelname</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PCM labels&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[]&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span>

        <span class="c1"># Add labels to the dataset:</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">labelname</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> variable already in the dataset: overwriting&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">labelname</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">labelname</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="k">return</span> <span class="n">ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">fit_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelname</span><span class="o">=</span><span class="s1">&#39;PCM_LABELS&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate PCM parameters and predict classes.</span>

<span class="sd">        This method add these properties to the PCM object:</span>

<span class="sd">        - ``llh``: The log likelihood of the model with regard to new data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds: xarray.Dataset</span>
<span class="sd">            The dataset to work with</span>

<span class="sd">        feature: str</span>
<span class="sd">            The xarray.Dataset variable name to be used as the PCM feature. If not specified, the variable is identified as PCM[&#39;feature_name&#39;] or the variable having it as an attribute.</span>

<span class="sd">        inplace: boolean (False by default)</span>
<span class="sd">            If False, the method returns a xarray.DataArray with predicted labels</span>
<span class="sd">            If True, a xarray.DataArray with labels is added to the input xarray.Dataset</span>

<span class="sd">        labelname: string</span>
<span class="sd">            Name of the DataArray holding labels, default is &#39;PCM_LABELS&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Component labels (if option &#39;inplace&#39; = False)</span>

<span class="sd">        **or**</span>

<span class="sd">        xarray.Dataset</span>
<span class="sd">            Input dataset with component labels as a &#39;PCM_LABELS&#39; new xarray.DataArray (if option &#39;inplace&#39; = True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># PRE-PROCESSING:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>

        <span class="c1"># CLASSIFICATION-MODEL TRAINING:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Done fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trained</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># CLASSIFICATION PREDICTION:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Now prepare xarray for output:</span>

        <span class="c1"># Identify the feature name in the dataset:</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_feature_name</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">sampling_axis_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># feature_axis_name = str(ds[feature_name].dims[1])</span>

        <span class="c1"># Identify the sampling dimension name:</span>
        <span class="c1"># dim_sample_name = list(set(ds[feature_name].dims).symmetric_difference([feature_axis]))[0]</span>

        <span class="c1"># Create a xarray.DataArray with labels:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">sampling_axis_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">labelname</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PCM labels&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[]&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span>

        <span class="c1"># Add labels to the dataset:</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">labelname</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> variable already in the dataset: overwriting&quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">labelname</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">labelname</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="k">return</span> <span class="n">ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">labels</span>
        <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">probname</span><span class="o">=</span><span class="s1">&#39;PCM_POST&#39;</span><span class="p">,</span> <span class="n">classaxisname</span><span class="o">=</span><span class="s1">&#39;N_CLASS&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict posterior probability of each component given the data</span>

<span class="sd">           This method adds these properties to the PCM instance:</span>
<span class="sd">               llh: The log likelihood of the model with regard to new data</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ds: xarray.Dataset</span>
<span class="sd">            feature: str, optional</span>
<span class="sd">                The xarray.Dataset variable name to be used as the PCM feature. If not specified, the</span>
<span class="sd">                variable is identified as PCM[&#39;feature_name&#39;] or the variable having it as an attribute.</span>
<span class="sd">            inplace: boolean, False by default</span>
<span class="sd">                If False, the method returns a xarray.DataArray with predicted labels</span>
<span class="sd">                If True, a xarray.DataArray with labels is added to the input xarray.Dataset</span>
<span class="sd">            probname: str, default is &#39;PCM_POST&#39;</span>
<span class="sd">                Name of the DataArray with prediction probability (posteriors)</span>
<span class="sd">            classaxisname: str, default is &#39;N_CLASS&#39;</span>
<span class="sd">                Name of the dimension holding classes</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            xarray.DataArray</span>
<span class="sd">                Probability of each Gaussian (state) in the model given each</span>
<span class="sd">                sample (if option &#39;inplace&#39; = False)</span>
<span class="sd">            or</span>
<span class="sd">            xarray.Dataset</span>
<span class="sd">                Input dataset with Component Probability as a &#39;PCM_POST&#39; new xarray.DataArray</span>
<span class="sd">                (if option &#39;inplace&#39; = True)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the PCM is trained:</span>
        <span class="n">validation</span><span class="o">.</span><span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_trained&#39;</span><span class="p">,</span>
                                   <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;This </span><span class="si">%(name)s</span><span class="s2"> instance is not fitted yet. Call fit with appropriate &quot;</span>
                                       <span class="s2">&quot;arguments before using the predict method.&quot;</span><span class="p">)</span>

        <span class="c1"># PRE-PROCESSING:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>

        <span class="c1"># CLASSIFICATION PREDICTION:</span>
        <span class="n">post_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Prepare xarray output:</span>

        <span class="c1"># Identify the feature name in the dataset:</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_feature_name</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">sampling_axis_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Create a xarray.DataArray with posteriors:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">post_values</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">sampling_axis_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="n">sampling_axis_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">classaxisname</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]))],</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">probname</span><span class="p">)</span>
        <span class="n">post</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PCM posteriors&#39;</span>
        <span class="n">post</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[]&#39;</span>
        <span class="n">post</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">post</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;valid_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">post</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;llh&#39;</span><span class="p">]</span>

        <span class="c1"># Add labels to the dataset:</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">probname</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> variable already in the dataset: overwriting&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">probname</span><span class="p">))</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">probname</span><span class="p">]</span> <span class="o">=</span> <span class="n">post</span>
            <span class="k">return</span> <span class="n">ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">post</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access plotting functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_PlotMethods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">v5</span> <span class="k">as</span> <span class="n">pcm</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">datasets</span> <span class="k">as</span> <span class="n">pcm_data</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">pcm_data</span><span class="o">.</span><span class="n">load_argo</span><span class="p">()</span>
    <span class="c1"># print dtrain</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">feature_axis</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;DEPTH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">feature_name</span><span class="o">=</span><span class="s1">&#39;TEMP&#39;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">m</span>
    <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Add labels to the dataset</span>
    <span class="nb">print</span> <span class="n">ds</span>
    <span class="n">m</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">probname</span><span class="o">=</span><span class="s1">&#39;POSTERIORS&#39;</span><span class="p">,</span>
                    <span class="n">classaxisname</span><span class="o">=</span><span class="s1">&#39;N_COMPONENT&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">ds</span>

</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Guillaume Maze.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>